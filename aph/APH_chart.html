<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <title>APH Chart</title>
        <style>
          div.tooltip {
            position: fixed;
            text-align: center;
            width: 60px;
            height: 28px;
            padding: 2px;
            font: 12px sans-serif;
            background: lightsteelblue;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
          }
          
          </style>
       
    </head>
    <body>
      <script src="https://d3js.org/d3.v5.min.js"></script>
      <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
      <select id="OccupationButton"></select>
      <select id="CategoryButton"></select>
      <div id="APH_charts"></div>

        <script>
          // set the dimensions and margins of the graph
          var margin = {top: 10, right: 30, bottom: 30, left: 60},
              width = 600 - margin.left - margin.right,
              height = 600 - margin.top - margin.bottom;

          // Parse the month variable
          var formatYear = d3.timeFormat("%Y");
          var parseYear = d3.timeParse("%Y");

          // append the svg object to the body of the page
          var svg = d3.select("#APH_charts")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform",
                    "translate(" + margin.left + "," + margin.top + ")");
          //tooltip
          var tip = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

          //Read the data
          d3.csv("combined.csv").then(function(earningsData){
            earningsData.forEach(function(d){
              d.Occupation = d.Occupation;
              d.Name = d.Name;
              d.Category = d.Category;
              d.Year = formatYear(parseYear(+d.Year));
              d.earnings = +d.earnings;
            });

            // List of groups (here I have one group per column)
            var allGroup = d3.map(earningsData, function(d){return(d.Name)}).keys();
            var OccupationList = d3.map(earningsData, function(d){return(d.Occupation)}).keys();
            var CategoryList = d3.map(earningsData, function(d){return(d.Category)}).keys();

            console.log(allGroup)

              // Add the options to both buttons
              d3.select("#OccupationButton")
                .selectAll('option')
                .data(OccupationList)
                .enter()
                .append('option')
                .text(function (d) { return d; }) // text showed in the menu
                .attr("value", function (d) { return d; }) // corresponding value returned by the button

              d3.select("#CategoryButton")
                .selectAll('option')
                .data(CategoryList)
                .enter()
                .append('option')
                .text(function (d) { return d; }) // text showed in the menu
                .attr("value", function (d) { return d; }) // corresponding value returned by the button

              // A color scale: one color for each group
              var myColor = d3.scaleOrdinal()
                .domain(allGroup)
                .range(d3.schemeSet2);

                          // Add X axis 
              // Scale the range of the data
              var xScale = d3.scaleLinear()
                .domain([d3.min(earningsData, d=>d["Year"]-1), d3.max(earningsData, d=>d["Year"])])
                .range([ 0, width ]);
              svg.append("g")
                .attr("class", "xaxis")
                .attr("transform", "translate(0," + height + ")")
                .call(d3.axisBottom(xScale));

              // Add Y axis
              var yScale = d3.scaleLinear()
                .domain([0, d3.max(earningsData, d=>d["earnings"])])
                .range([ height, 0 ]);
              svg.append("g")
                .attr("class", "yaxis")
                .call(d3.axisLeft(yScale));
              
              //add xlabel
              // text label for the x axis
              svg.append("text")             
                .attr("transform",
                      "translate(" + (width/2) + " ," + (height + margin.top + 20) + ")")
                .style("text-anchor", "middle")
                .text("Year");

              //add y label
              // text label for the y axis
              svg.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 0 - margin.left)
                .attr("x",0 - (height / 2))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .text("Income $MM");   
              
              // Initialize line with first group of the list  
              var line = d3.line()
                //.interpolate("basis")
                .x(function(d) {return xScale(d.Year); })
                .y(function(d) {return yScale(d.earnings); })
                .defined(function(d) { return d.earnings; }); 

              // A function that update the chart
              function update(selectedGroup) {

                // Create new data with the selection?
                var dataFilter = earningsData.filter(function(d){return d.Occupation==selectedGroup})

                // Give these new data to update line
               line
                   .datum(dataFilter)
                   .transition()
                    .duration(1000)
                   .attr("d", d3.line()
                   .x(function(d) { return x(d.year) })
                   .y(function(d) { return y(d.earnings) })
                    )
                   .attr("stroke", function(d){ return myColor(selectedGroup) })

                //update x axis
                svg.select('.xaxis')
                 .transition()
                 .duration(1000)
                 .call(d3.axisBottom(x));     

                //update y axis

                svg.select('.yaxis')
                .transition()
                .duration(1000)
               .call(d3.axisLeft(y));
              }

              function update2(selectedGroup) {
              var newgroup = earningsData.filter(function(d){return d.Category==selectedGroup});
              var newGroup = d3.map(newgroup, function(d){return(d.name)}).keys();
              console.log(newGroup)

              d3.select("#OccupationButton")
                .selectAll('option')
                .remove();

                // add the options to the button
              var newbutton = d3.select("#OccupationButton")
                .selectAll('option')
                .data(newGroup);
                
                newbutton
                .enter()
                .append('option')
                .text(function (d) { return d; }) // text showed in the menu
                .attr("value", function (d) { return d; });

                update(newGroup[0])

              }
              // When the button is changed, run the updateChart function
              d3.select("#OccupationButton").on("change", function(d) {
                  // recover the option that has been chosen
                  var selectedOption = d3.select(this).property("value")
                  // run the updateChart function with this selected option
                  update(selectedOption)
              })
              d3.select("#CategoryButton").on("change", function(d) {
                  // recover the option that has been chosen
                  var selectedOption = d3.select(this).property("value")
                  // run the updateChart function with this selected option
                  update(selectedOption)
              })

          })


          </script>
  
    </body>
</html>